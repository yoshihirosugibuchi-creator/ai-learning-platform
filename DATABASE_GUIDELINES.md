# データベース作業ガイドライン

## 概要
このドキュメントは、プロジェクトでのSQL/データベース作業における標準的な手順とルールを定義します。過去のトリガー関連の問題を避け、一貫した作業手順を確保するためのものです。

## 基本ルール

### 1. データベースアクセス方法
- **クライアント環境にはPSQLがインストールされていない**
- 基本的なSQL操作はスクリプトを作成し、Supabase（SB）で直接実行してもらう
- Claude Code からの直接DB接続は行わない

### 2. テーブル設計の原則
- **トリガーは使用しない**
  - 過去にuser_xp_statsでトリガーによる問題が発生した
  - レベル計算、統計更新はすべてアプリケーション側で実行
  - トリガーが必要な場合は、v2テーブルとして新規作成を検討

### 3. テーブル命名規則
- 問題のあるテーブルの修正版は `tablename_v2` として新規作成
- 旧テーブルは残しておき、移行後に削除を検討
- 例：`user_xp_stats` → `user_xp_stats_v2`

## SQL作業の標準手順

### 1. 新しいテーブル作成時
1. トリガーを含まないシンプルなテーブル構造で設計
2. RLS（Row Level Security）を適用
3. 必要なインデックスを作成
4. アプリケーション側でのデータ管理を前提とした設計

### 2. 既存テーブルの変更時
1. まず現在のテーブル構造を確認
2. トリガーが存在する場合は、v2テーブルの作成を検討
3. 段階的な移行計画を立てる

### 3. データベーススクリプト作成時
1. `database/` ディレクトリに配置
2. ファイル名は目的を明確にする
   - 例：`create_user_category_xp_stats_v2.sql`
3. エラーハンドリングを含める（`IF NOT EXISTS` など）
4. コメントを充実させる

## 問題回避のチェックリスト

### テーブル作成前
- [ ] トリガーの必要性を検討（基本的には不要）
- [ ] RLSポリシーの設計
- [ ] アプリケーション側での管理方法を確認

### テーブル作成後
- [ ] 必要なインデックスが作成されているか
- [ ] RLSが正しく設定されているか
- [ ] アプリケーション側のコードが対応しているか

## 過去の問題事例

### user_xp_stats トリガー問題
- **問題**: `xp_level_skp_settings`テーブルへのアクセスでトリガーエラー
- **解決**: `user_xp_stats_v2`をトリガーなしで作成
- **教訓**: レベル計算はアプリケーション側で実行

### category statistics トリガー問題
- **問題**: `category_threshold`カラムエラーでupsert失敗
- **解決**: v2テーブル作成予定
- **教訓**: カテゴリー統計もアプリケーション側で管理

## 推奨ツールとスクリプト

### データベース確認用スクリプト
```typescript
// scripts/check-database-schema.ts
// テーブル構造やデータを確認するためのスクリプト
```

### 移行用スクリプト
```sql
-- 旧テーブルから新テーブルへのデータ移行用
-- 段階的移行を考慮した設計
```

## 参考情報

### Supabase RLS設定例
```sql
-- ユーザーは自分のデータのみアクセス可能
CREATE POLICY "user_policy" ON table_name
    FOR ALL USING (auth.uid() = user_id);
```

### インデックス作成例
```sql
-- パフォーマンス向上のための基本インデックス
CREATE INDEX IF NOT EXISTS idx_table_user_id ON table_name(user_id);
CREATE INDEX IF NOT EXISTS idx_table_category_id ON table_name(category_id);
```

## 更新履歴
- 2025-09-28: 初版作成（カテゴリー統計トリガー問題対応時）