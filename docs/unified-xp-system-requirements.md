# 統合XPシステム要件仕様書

**作成日**: 2025-09-25  
**最終更新**: 2025-09-25  
**目的**: クイズとコース学習の統合XP集計システムの要件定義

---

## 🎯 システム目標

1. **クイズ結果の正確なXP計算と記録**
2. **コース学習結果の正確なXP計算と記録**  
3. **カテゴリー・サブカテゴリー別XP自動集計**
4. **マイページでのスキル評価表示**
5. **学習分析でのXP詳細表示**

---

## 🔥 クイズシステム要件

### **基本仕様**
- **出題数**: 1回のクイズは10問固定
- **完了条件**: 10問すべて回答完了（途中放棄は未獲得）
- **制限時間**: 各問題に制限時間あり
- **時間切れ処理**: 自動で正解表示、XP対象外

### **XP計算ロジック**
```
【各問題のXP】
正解時のXP = 基礎点10 × 難易度倍率
不正解・時間切れ = 0XP

【難易度倍率】
- 基礎: ×1.0
- 中級: ×1.2  
- 上級: ×1.5
- エキスパート: ×2.0

【ボーナスXP（セッション単位）】
- 正答率80%以上: +20XP → ユーザー合計XPに加算
- 正答率100%: +30XP → ユーザー合計XPに加算
```

### **XP集計先**
- **基本XP**: 各問題のサブカテゴリーに集計
- **例外**: `subcategory_id = 'category_level'` の問題は、カテゴリーレベルでのみ集計
- **ボーナスXP**: ユーザー全体統計にのみ加算（カテゴリー別集計対象外）

### **報酬システム**
- **正答率80%以上**: 格言カード1枚ランダム付与
- **正答率100%**: 格言カード2枚ランダム付与

---

## 🎓 コース学習システム要件

### **データ階層構造**
```
コースID (例: consulting_thinking_basics)
 └─ ジャンルID (例: thinking_foundation) ← サブカテゴリーIDに紐づく
     └─ テーマID (例: conclusion_first)
         └─ セッションID (例: conclusion_first_basics)
             ├─ コンテンツID (教材)
             └─ クイズID (セッション最後の確認クイズ)
```

### **XP付与条件**
- **対象**: セッション最後の確認クイズに正解した場合のみ
- **復習除外**: 復習でのクイズ正解はXP対象外（初回完了のみ）

### **XP計算ロジック**
```
【セッション完了XP】
セッション正解時のXP = 基礎点10 × コース難易度倍率

【コース完了ボーナス】
コース内すべてのセッション完了時: +20XP
```

### **XP集計先**
- **セッションXP**: ジャンルに紐づくサブカテゴリーに集計
- **完了ボーナス**: ユーザー全体統計に加算

### **報酬システム**
- **テーマ完了**: テーマ内全セッション完了時、ナレッジカード付与
- **コース完了**: コース内全セッション完了時、修了証（バッジ）付与

---

## 📊 表示要件

### **マイページ スキル評価**
- **ユーザー合計XP**: 全XP合計表示
- **mainカテゴリー**: カテゴリー別XP表示
- **industryカテゴリー**: カテゴリー別XP表示

### **学習分析画面**
- **industryカテゴリー**: サブカテゴリー別XP表示（確定）
- **mainカテゴリー**: サブカテゴリー別XP表示（将来対応予定）

---

## ⚙️ 管理者設定要件

### **変更可能なXP設定**
```
【クイズ】
- 基礎点: デフォルト10XP
- 難易度倍率: 基礎1.0、中級1.2、上級1.5、エキスパート2.0  
- 80%以上ボーナス: デフォルト20XP
- 100%ボーナス: デフォルト30XP

【コース学習】
- セッション基礎点: デフォルト10XP
- 難易度倍率: クイズと同様
- コース完了ボーナス: デフォルト20XP
```

---

## 🚨 例外ケース

### **Category Level問題（クイズ）**
- **判定方法**: `subcategory_id = 'category_level'`
- **集計先**: カテゴリーレベルでのみ集計（サブカテゴリー別集計対象外）
- **XP計算**: 通常のクイズXP計算と同様

### **過去データの General カテゴリー**
- **対応方針**: 新システムでは無視（過去データ廃棄前提）
- **移行時**: generalカテゴリーのデータは削除対象

---

## 🏗️ データベース設計方針

### **記録の粒度**
1. **最詳細レベル**: 各問題・各セッションの個別記録
2. **セッションレベル**: クイズ1回分・コース学習1セッション分の結果
3. **集計レベル**: サブカテゴリー別・カテゴリー別・ユーザー全体統計

### **パフォーマンス要件**
- **リアルタイム更新**: 学習完了時の即時XP反映
- **表示高速化**: 集計テーブルでの事前計算済みデータ活用
- **整合性保証**: 詳細記録から集計への正確な反映

---

## 🔄 処理フロー概要

### **クイズ完了時**
```
1. 各問題の回答記録保存
2. 各問題のXP計算（サブカテゴリー別 or カテゴリー別）
3. セッション全体の正答率計算
4. ボーナスXP判定・付与（ユーザー全体統計）
5. 集計テーブル更新
6. 格言カード報酬付与判定
```

### **コース学習完了時**
```
1. セッション完了記録保存（初回判定）
2. セッションクイズ正解時のXP計算（サブカテゴリー別）
3. テーマ完了判定・ナレッジカード付与
4. コース完了判定・修了証+ボーナスXP付与
5. 集計テーブル更新
```

---

## 📋 実装優先順位

### **Phase 1: 基盤テーブル作成**
1. クイズ記録テーブル群
2. コース学習記録テーブル群  
3. XP集計テーブル群
4. 管理者設定テーブル

### **Phase 2: XP計算ロジック実装**
1. クイズXP計算関数
2. コース学習XP計算関数
3. 集計更新ロジック
4. 例外ケース対応

### **Phase 3: API・UI実装**
1. 学習記録保存API
2. XP統計取得API
3. マイページ表示機能
4. 学習分析表示機能

---

**この要件書に基づいてシステムを実装していきます。**