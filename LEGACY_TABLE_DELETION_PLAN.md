# レガシーテーブル削除作業計画書

**作成日**: 2025年10月1日  
**対象**: AI学習プラットフォーム 不要テーブル削除  
**実施者**: Claude Code AI Assistant  

## 📋 作業概要

### 削除対象テーブル（8テーブル）

1. **`category_progress`** - v2への移行完了済み（70件のデータ）
2. **`detailed_quiz_data`** - `quiz_answers`に移行済み  
3. **`quiz_results`** - `quiz_sessions`に移行済み
4. **`user_category_xp_stats`** (v1) - v2へ移行完了済み
5. **`user_progress`** - v2統計システムに移行済み
6. **`user_subcategory_xp_stats`** (v1) - v2へ移行完了済み（2件残存）
7. **`user_xp_stats`** (v1) - v2へ移行完了済み
8. **`xp_settings`** - `xp_level_skp_settings`に移行済み（17件の設定）

### 根拠

- **DATABASE_TABLE_ANALYSIS.md**の調査結果に基づく
- 2025年9月30日にv2テーブルへの移行作業完了済み
- アプリケーションコードでのレガシーテーブル参照を完全削除済み

## 🚀 作業フェーズ

### Phase 1: 最終影響チェック
**目的**: 削除前の最終安全性確認  
**作業内容**:
- 削除対象8テーブルのコード内参照最終確認
- scripts/フォルダ内のデバッグ・管理スクリプト確認
- 外部依存関係（Vercel Functions等）確認

### Phase 2: バックアップ実行
**目的**: データ復旧保証の確立  
**作業内容**:
- SQLダンプ形式でのテーブル構造+データバックアップ
- CSVエクスポートでのデータバックアップ（二重化）
- バックアップファイルの整合性検証

**保存場所**: 
- **ローカル**: `./database/backup/legacy_tables_backup_YYYYMMDD/`
- **記録**: バックアップ作業ログをLEGACY_TABLE_DELETION_LOG.mdに記録

### Phase 3: リストア手順書作成
**目的**: 緊急復旧手順の確立  
**作業内容**:
- 各テーブルの復元SQLコマンド作成
- データ整合性チェック手順の作成
- ロールバック判断基準の明文化

### Phase 4: テーブル削除実行
**目的**: 不要テーブルの物理削除  
**作業内容**:
- 依存関係を考慮した削除順序での実行
- 各削除後の動作確認（API・UI）
- 完了確認とログ記録

### Phase 5: 作業完了確認と記録保存
**目的**: 作業の完全性確認と記録保存  
**作業内容**:
- 全システム動作確認（クイズ・学習・統計機能）
- 削除作業ログの最終記録
- 成功・失敗の詳細記録

## ⏱️ 予想作業時間

| フェーズ | 予想時間 | 作業内容 |
|---------|---------|---------|
| Phase 1 | 30分 | コード確認・依存関係チェック |
| Phase 2 | 30分 | バックアップ実行・検証 |
| Phase 3 | 15分 | リストア手順書作成 |
| Phase 4 | 20分 | テーブル削除・動作確認 |
| Phase 5 | 15分 | 最終確認・記録保存 |
| **合計** | **110分** | **約1時間50分** |

## ⚠️ リスク管理

### 1. データ保護策
- **2重バックアップ**: SQL + CSV両形式
- **即座復元可能**: 詳細リストア手順書
- **段階的削除**: 1テーブルずつ削除・確認

### 2. 影響範囲制限
- **本番データベース**: Supabase本番環境での実行
- **影響確認**: 各削除後に主要機能の動作確認
- **ロールバック基準**: 任意のAPI/UI異常検出時

### 3. 作業記録
- **LEGACY_TABLE_DELETION_LOG.md**: 全作業の詳細ログ
- **バックアップディレクトリ**: 日付付きでバックアップ保存
- **成功・失敗記録**: 次回作業への知見保存

## 📝 削除順序（依存関係考慮）

1. `detailed_quiz_data` - 詳細記録テーブル（他テーブル依存なし）
2. `quiz_results` - 旧結果テーブル（他テーブル依存なし）
3. `user_progress` - 旧進捗テーブル（他テーブル依存なし）
4. `category_progress` - 旧カテゴリー進捗（他テーブル依存なし）
5. `user_subcategory_xp_stats` (v1) - サブカテゴリー統計
6. `user_category_xp_stats` (v1) - カテゴリー統計
7. `user_xp_stats` (v1) - ユーザー統計
8. `xp_settings` - 旧設定テーブル（最後に削除）

## ✅ 成功基準

- [ ] 8テーブル全ての物理削除完了
- [ ] バックアップファイルの作成・検証完了
- [ ] 主要機能（クイズ・学習・統計）の正常動作確認
- [ ] 作業ログの完全記録
- [ ] リストア手順書の作成完了

---

**作業開始時刻**: [記録予定]  
**作業完了時刻**: [記録予定]  
**作業者**: Claude Code AI Assistant  
**承認**: [承認予定]